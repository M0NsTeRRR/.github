{%- set tag_prefix %}
{%- if language == "go" %}v{% endif -%}
{% endset -%}
---
# THIS FILE IS GENERATED! DO NOT EDIT! Maintained by Pulumi
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
{%- set included_content -%}
{%- if package %}
{%- include "workflow/{}/package.yml.j2".format(language) %}
{%- endif %}
{%- if documentation %}
{%- include "workflow/{}/documentation.yml.j2".format(language) %}
{%- endif %}
{%- if docker %}
{%- include "workflow/docker/package.yml.j2" -%}
{%- endif %}
{%- endset -%}
{%- set needs = ["create-draft-release"] %}
{%- if package %}
{%- if language == "python" %}
{% do needs.append("publish-package") %}
{%- else %}
{% do needs.append("verify-artifact") %}
{%- endif %}
{%- endif %}
{%- if documentation %}{% do needs.append("documentation") %}{% endif -%}
{%- if docker %}{% do needs.append("verify-docker") %}{% endif -%}
name: Release
on:
  push:
    tags:
      - "{{ tag_prefix }}*"
permissions: {}
concurrency:
  group: release-{{ "${{" }} github.ref {{ "}}" }}
  cancel-in-progress: true
jobs:
{%- if changelog %}
{%- set included_template %}
{%- include "workflow/changelog/main.yml.j2" %}
{%- endset %}
{{- included_template | indent(2) }}
{% endif %}
  create-draft-release:
    name: Create release as draft
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    {%- if changelog %}
    needs: [changelog]
    {% endif -%}
    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: false

      - name: Create release as draft
        run: |
          if [[ "$GITHUB_REF_NAME" =~ (alpha|beta|rc) ]]; then
            gh release create {{ "${" }}GITHUB_REF_NAME{{ "}" }}  -t "Release {{ "${" }}GITHUB_REF_NAME{{ "}" }}" {%- if changelog %} -n "{{ "${" }}RELEASE_BODY{{ "}" }}"{% endif %} --draft --prerelease
          else
            gh release create {{ "${" }}GITHUB_REF_NAME{{ "}" }}  -t "Release {{ "${" }}GITHUB_REF_NAME{{ "}" }}" {%- if changelog %} -n "{{ "${" }}RELEASE_BODY{{ "}" }}"{% endif %} --draft
          fi
        env:
          GITHUB_TOKEN: {{ "${{" }} secrets.GITHUB_TOKEN {{ "}}" }}
          RELEASE_BODY: {{ "${{" }} needs.changelog.outputs.release_body {{ "}}" }}
{{ included_content | indent(2) }}
  publish-release:
    name: Publish release
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    needs: [{{ needs | join(", ") }}]
{%- raw %}
    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          persist-credentials: false

      - name: Create release
        run: gh release edit ${GITHUB_REF_NAME} --draft=false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
{%- endraw %}
